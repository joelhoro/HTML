<link href="css/jquery.treetable.theme.default.css" rel="stylesheet" type="text/css" />
<script src="lib/jquery.js"></script>
<script src="lib/underscore.js"></script>
<script src="lib/jquery.treetable.js"></script>
<script src="data.js"></script>
<script src="utils.js"></script>
<script src="pivottable.js"></script>

<style>
      .hidden {
            visibility: hidden;
      }
</style>

  <table class='hidden' id="pivottable">
        <caption>
          <a href="#" onclick="jQuery('#pivottable').treetable('expandAll'); return false;">Expand all</a>
          <a href="#" onclick="jQuery('#pivottable').treetable('collapseAll'); return false;">Collapse all</a>
        </caption>
        <thead>
          <tr>
            <th id='pivotFieldSequence'></th>
          </tr>
        </thead>
        <tbody>
        </tbody>
  </table>

<script>



//data = data.filter(function(row) { return row["Qtr 1"] > 0; });

      
      
class TreeModel {
      constructor(table,source,pivots,valueFields) {
            this.table = table;
            this.source = source;
            this.nodesDictionary = [{}];
            this.openNodes = {};
            this.valueFields = valueFields;
            this.pivots = pivots;
            this.id = 0;
            this.rowTemplate = _.template("<tr onclick='treeModel.query(<%= newid %>,<%= pivotLevel %>)' data-tt-id='<%= newid %>' data-tt-parent-id='<%= parentid %>' ><td><span class=folder><%= key %></span></td><%= values %></tr>");

      }

      addNode(baseNode,obj,currentField,pivotLevel) { 
            var parentid;
            if(baseNode == null)
                  parentid = 0;
            else
                  parentid = baseNode.id;
            this.id++;
            var id = this.id;
            this.nodesDictionary[id] = _.clone(this.nodesDictionary[parentid])
            this.nodesDictionary[id][currentField]=obj.key;

            var values = this
                  .valueFields
                  .map(ObjectFn(obj))
                  .map(HTMLWrapper("td"))
                  .join("\n");
            var newNode = this.rowTemplate({ parentid: parentid, newid : id, key: obj.key, 
                  pivotLevel: pivotLevel, pivots: this.pivots, values: values } );
            
            this.table.treetable("loadBranch", baseNode, newNode );
      }

      query(id, pivotLevel) {
                  var node = this.table.treetable("node",id);
                  if (this.openNodes[id] != undefined) {
                        node.toggle();
                        return;
                  }
                  this.openNodes[id] = 1;
                  var filter = this.nodesDictionary[id];
                  var nextPivot = this.pivots[pivotLevel];
                  var newData = this.source.drilldown(filter, nextPivot,this.valueFields);

                  var thiscopy = this;
                  newData.map(function(row) {
                         thiscopy.addNode(node, row, nextPivot, pivotLevel+1 );
                  })
      }

}

$(document).ready(function() {
      var table = $("#pivottable");
      var data = window.data.slice(0,100);
      var source = new PivotTableSourceFromTable(data);
      var id = 0;
      var valueFields = [ "Qtr 1", "Qtr 2", "Qtr 3", "Qtr 4" ];
      var pivots = [ "Product", "Customer" ];

      var treeModel = new TreeModel(table,pivottable,pivots,valueFields);
      window.treeModel = treeModel;


      table.treetable({ expandable: true }).treetable("expandAll");

      $("thead tr").append(valueFields.map(HTMLWrapper("th")));
      $("#pivotFieldSequence").html(pivots.join(" &gt;&gt; "));

      $(".hidden").removeClass("hidden");
      var values = valueFields
            .map(function() { return ""; })
            .map(HTMLWrapper("td"))
            .join("\n");
      var root = { parentid: -1, newid : 0, key: "Sales database", value: "", pivotLevel: 0, pivots: pivots, values: values };
      table.treetable("loadBranch",null,treeModel.rowTemplate(root));
      var rootNode = $("[data-tt-id='0']");
      rootNode.click();
})


</script>