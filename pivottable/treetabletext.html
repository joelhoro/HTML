<link href="css/jquery.treetable.theme.default.css" rel="stylesheet" type="text/css" />
<script src="lib/jquery.js"></script>
<script src="lib/underscore.js"></script>
<script src="lib/jquery.treetable.js"></script>
<script src="lib/angular.js"></script>
<script src="data.js"></script>
<script src="data2.js"></script>
<script src="utils.js"></script>
<script src="pivottablesource.js"></script>
<script src="pivottable.js"></script>

<style>
      .hidden {
            visibility: hidden;
      }
</style>

<title>PivotTable test</title>

<div ng-app="pivottable" ng-controller="pivottableCtrl">
<span>Started at: {{ startTime }} | useAjax={{useAjax}}</span>
  <table class='hidden' id="pivottable">
        <caption>
          <a href="#" onclick="jQuery('#pivottable').treetable('expandAll'); return false;">Expand all</a>
          <a href="#" onclick="jQuery('#pivottable').treetable('collapseAll'); return false;">Collapse all</a>
        </caption>
        <thead>
        </thead>
        <tbody>
        </tbody>
  </table>
</div>

<script>


var app = angular.module('pivottable', 
      ['dataService','utilsService', 'pivotTableService'] );
app.controller("pivottableCtrl", function($scope,$,$http,data2,PivotTable, PivotTableSourceFromTable, PivotTableSourceAjax) {
      console.log("Starting pivottable at %s", new Date());
      $scope.startTime = new Date();

      // HTML placeholder
      var table = $("#pivottable");
      var useAjax = location.search.indexOf("useAjax") != -1;
      $scope.useAjax = useAjax;
      //var valueFields = [ "Qtr 1", "Qtr 2", "Qtr 3", "Qtr 4" ];
      //var pivots = [ "Product", "Customer" ];

      var pivots = [ /* "Order Priority", "Ship Mode",  */ "Product Category", "Product Sub-Category", "Product Name","Region", "Province"  ];
      var valueFields = ["Sales" ];

      $scope.valueFields = valueFields;
      $scope.pivots = pivots;

      var limit = -1;
      if(!useAjax) {
            // datasource from table
            var data = data2.slice(0,limit);

            var source = new PivotTableSourceFromTable(data, pivots, valueFields);
      }
      else {
            // datasource from Ajax
            var url = "http://localhost:17041/DBAccessor.asmx/Query";
            var settings = { limit: limit };
            var source = new PivotTableSourceAjax(url, settings, pivots, valueFields);
      }

      var classes = [ "Folder", "File", "File" ];
      new PivotTable(table,source,pivots,valueFields,classes);

      $(".hidden").removeClass("hidden");
} );

</script>