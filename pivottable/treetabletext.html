<link href="css/jquery.treetable.theme.default.css" rel="stylesheet" type="text/css" />
<script src="lib/jquery.js"></script>
<script src="lib/underscore.js"></script>
<script src="lib/jquery.treetable.js"></script>
<script src="data.js"></script>
<script src="utils.js"></script>

<style>
      .hidden {
            visibility: hidden;
      }
</style>

  <table class='hidden' id="pivottable">
        <caption>
          <a href="#" onclick="jQuery('#pivottable').treetable('expandAll'); return false;">Expand all</a>
          <a href="#" onclick="jQuery('#pivottable').treetable('collapseAll'); return false;">Collapse all</a>
        </caption>
        <thead>
          <tr>
            <th id='pivotFieldSequence'></th>
          </tr>
        </thead>
        <tbody>
        </tbody>
  </table>

<script>


valueFields = [ "Qtr 1", "Qtr 2", "Qtr 3", "Qtr 4" ];
pivots = [ "Product", "Customer" ];

data = data.slice(0,100);
//data = data.filter(function(row) { return row["Qtr 1"] > 0; });

function getdataforpath(filter, nextPivot) {
      var filteredData = data.where(filter);
      
      var groupedData = filteredData.groupBy(FieldExtractor(nextPivot));
      var returnValue = _.map(groupedData,function(values,key) {
            var summary = valueFields
                  .toObject(function(field) { return values.sum(FieldExtractor(field)); });
            summary.key = key;
            return summary;
      });
      return returnValue;
}

function query(id, pivotLevel) {
      var table = $("#pivottable");
      var node = table.treetable("node",id);
      if (openNodes[id] != undefined) {
            node.toggle();
            return;
      }
      openNodes[id] = 1;
      var filter = nodesDictionary[id];
      var nextPivot = pivots[pivotLevel];
      var newData = getdataforpath(filter, nextPivot);

      newData.map(function(row) {
             addNode(node, row, nextPivot, pivotLevel+1 );
       })
}


$(document).ready(function() {
      var table = $("#pivottable");
      var id = 0;
      nodesDictionary = [{}];
      openNodes = {};

      var rowTemplate = _.template("<tr onclick='query(<%= newid %>,<%= pivotLevel %>)' data-tt-id='<%= newid %>' data-tt-parent-id='<%= parentid %>' ><td><span class=folder><%= key %></span></td><%= values %></tr>");
      function addNode(baseNode,obj,currentField,pivotLevel) { 
            var parentid;
            if(baseNode == null)
                  parentid = 0;
            else
                  parentid = baseNode.id;
            id++;

            nodesDictionary[id] = _.clone(nodesDictionary[parentid])
            nodesDictionary[id][currentField]=obj.key;

            var values = valueFields
                  .map(ObjectFn(obj))
                  .map(HTMLWrapper("td"))
                  .join("\n");
            var newNode = rowTemplate({ parentid: parentid, newid : id, key: obj.key, 
                  pivotLevel: pivotLevel, pivots: pivots, values: values } );
            
            table.treetable("loadBranch", baseNode, newNode );
      }
      window.addNode = addNode;

      table.treetable({ expandable: true }).treetable("expandAll");

      $("thead tr").append(valueFields.map(HTMLWrapper("th")));
      $("#pivotFieldSequence").html(pivots.join(" &gt;&gt; "));

      $(".hidden").removeClass("hidden");
      var values = valueFields
            .map(function() { return ""; })
            .map(HTMLWrapper("td"))
            .join("\n");
      var root = { parentid: -1, newid : 0, key: "Sales database", value: "", pivotLevel: 0, pivots: pivots, values: values };
      table.treetable("loadBranch",null,rowTemplate(root));
      var rootNode = $("[data-tt-id='0']");
      rootNode.click();
})


</script>